<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!--  -->
  <script src="/__/firebase/6.2.0/firebase-app.js"></script>
  <script src="/__/firebase/6.2.0/firebase-firestore.js"></script>
  <script src="/__/firebase/6.2.0/firebase-auth.js"></script>
  <script src="/__/firebase/init.js"></script>

    <title></title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>

<body>
    <!-- コピー対象要素とコピーボタン -->
    <input id="copyUrl" type="url" readonly>
    <button onclick="copyToClipboard()">URLをコピー</button>

    <div id="dragTableArea"></div>
    <div id="modal-content">
        <button id="close" onclick="modalClose()"> × </button>
        <button id="login" onclick="onClickLogin()">ログイン</button>
        ログインしないで利用:
        <input id="unLoginUserName" type="text" placeholder="名前を入力してください." style="width: 12em;">
    </div>
    <button id="scheduleSaveButton" onclick="scheduleSave()">登録</button>
</body>

<script src="firebaseCode.js"></script>
<script src="firebaseFunctions.js"></script>
<script>
    //----------------------------------------------------------------
    let db=firebase.firestore();
    //ログインしてない人の名前------------
    var unLoginUserName;
    var uid = null;
    //--------------------------------
    //メモ$("#copyUrl")[0]
    //テーブル作成------------------------------------------------------
    //状況の取得------------------------

    var tableTag = $("<table id=\"dragTable\" cellpadding=\"0\" cellspacing=\"0\">");
    var tableFirstRow = $("<tr></tr>").appendTo(tableTag);
    $("<th rolspan=\"2\"></th>").appendTo(tableFirstRow);
    var finish = getProjectPeriodFinish();
    console.log(finish);
    for (var i = getProjectPeriodStart(); i <= finish; i.setDate(i.getDate() + 1)) {
        $("<th colspan=\"144\">" + i + "</th>").appendTo(tableFirstRow);
    }
    var tableSecondRow = $("<tr></tr>").appendTo(tableTag);
    $("<th></th>").appendTo(tableSecondRow);
    for (var i = getProjectPeriodStart(); i <= finish; i.setDate(i.getDate() + 1)) {
        for (var j = 0; j < 24; j++) {
            $("<th colspan=\"6\" class=\"time\">" + j + ":" + "</th>").appendTo(tableSecondRow);
        }
    }
    //それぞれのメンバーの行--------------
    console.log(async(getProjectMembers()));
    var memberNum = async(getProjectMembers());
    console.log(memberNum);
    for (var i = 0; i < memberNum.length; i++) {
        var memberRow = getProjectMemberSchedule(i);
        var tableRow = $("<tr></tr>").appendTo(tableTag);
        $("<td>" + getProjectMembers()[i] + "</td>").appendTo(tableRow);
        var count = 0;
        for (var j = getProjectPeriodStart(); j <= finish; j.setDate(j.getDate() + 1)) {
            for (var k = 0; k < 144; k++) {
                if (memberRow[count] == 0) {
                    $("<td class=\"notHighlight\"></td>").appendTo(tableRow);
                } else {
                    $("<td class=\"highlighted\"></td>").appendTo(tableRow);
                }
                count++;
            }
        }
    }
    //新規欄-----------------------------------------------------------
    var tableRow = $("<tr></tr>").appendTo(tableTag);
    var plusCellbox = $("<td></td>").appendTo(tableRow);
    //認証状態の確認
    firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
            userid = firebase.auth().currentUser.uid;
        }
    });
    //-仮用--------------------------------------------------------------------------------------------------------------------------------------
    //uid = "a";
    if (uid != null) {
        //ログインした人のための処理----------
        $("<p>" + getUserName(uid) + "<p>").appendTo(plusCellbox);
        var userSchedule = getUserSchedule(uid);
        var i = 0;
        for (var j = getProjectPeriodStart(); j <= finish; j.setDate(j.getDate() + 1)) {
            for (var k = 0; k < 144; k++) {
                if (userSchedule[i] == 0) {
                    $("<td id=\"cell" + i + "\" class=\"drag\"></td>").appendTo(tableRow);
                } else {
                    $("<td id=\"cell" + i + "\" class=\"highlighted drag\"></td>").appendTo(tableRow);
                }
                i++;
            }
        }
    }
    else {
        //ログインしてない人のための処理-------
        var i = 0;
        $("<button id=\"modalOpen\" onclick=\"modalOpen()\"> + </button>").appendTo(plusCellbox);
        for (var j = getProjectPeriodStart(); j <= finish; j.setDate(j.getDate() + 1)) {
            for (var k = 0; k < 144; k++) {
                $("<td id=\"cell" + i + "\" class=\"drag\"></td>").appendTo(tableRow);
                i++;
            }
        }
    }

    $("#dragTableArea").append(tableTag);

    function getProjectPeriod() {
        for (var i = getProjectPeriodStart(); i <= finish; i.setDate(i.getDate() + 1)) {
        }
        return i;
    }
    
    //仮のfunction----------------------------------------------------
    function getParam(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
    function getUserSchedule(uid) {
        return [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1];
    }
    function getUserName(uid) {
        return "ログイン済み";
    }
    /*
    function getProjectMembers(){
        let ID;
        let buff;
        ID = getParam("project");
        const docRef = db.ref("project/ID");
        let members;
        docRef.get().then((doc)=>{
            members = doc.data();
            console.log(members);
        }).catch((error)=>{
            console.log("データ取得失敗");
        })
        return members;
    }
    */
    
    async function getProjectMembers(){
        let ID;
        let buff;
        
        
        ID = getParam("project");
        buff = await db.collection("project").doc(ID).get().then((querySnapshot) => {
             //console.log(querySnapshot.data()["projectmenberName"]);
             let temp = querySnapshot.data()["projectmenberName"];
             console.log(temp);
             //buff = querySnapshot.data()["projectmenberName"];
             //console.log(buff);
             //return buff; //MemberのMがfirebaseで小文字になってる
             //console.log(start);
            //const docSnapshot = querysnapshot.docs;
            //console.log(docSnapshot);
            return temp;
        })
        .catch((error)=>{
            console.log("データの取得失敗");
        })
        console.log(buff);
        return buff; //MemberのMがfirebaseで小文字になってる
    }

    function getProjectPeriodStart(){
        let ID;
        
        ID = getParam("project");
        var buff;
        
        buff = db.collection("project").doc(ID);
        var start = buff.get().then((querySnapshot) => {
             //console.log(querySnapshot.data()["projectPeiriod"]); 
             let start =new Date(querySnapshot.data()["projectPeiriod"][0]/10000,(querySnapshot.data()["projectPeiriod"][0]%10000)/100,(querySnapshot.data()["projectPeiriod"][0]%100));
             //console.log(start);
             return start;
        })
        .catch((error)=>{
            console.log("データの取得失敗");
        })
        return start;
    }

    function getProjectPeriodFinish(){
        let ID;
        
        ID = getParam("project");
        var buff;
        
        buff = db.collection("project").doc(ID);
        buff.get().then((querySnapshot) => {
             //console.log(querySnapshot.data()["projectPeiriod"]); 
             let end =new Date(querySnapshot.data()["projectPeiriod"][1]/10000,(querySnapshot.data()["projectPeiriod"][1]%10000)/100,(querySnapshot.data()["projectPeiriod"][1]%100));
             //console.log(end);
             return end;
        })
        .catch((error)=>{
            console.log("データの取得失敗");
        })   
    }

    function getProjectMemberSchedule(memberIndex){
        var data = [];

        db.collection("project").doc(ID).collection(projectMenberPeriod).where("memberIndex","==",memberIndex)
        .get()
        .then((querySnapshot) =>{
            querySnapshot.forEach((doc) => {
                data = doc.data()["projectSchedule"];
                //projectSchedule.push(data.projectSchedule);
            });
        }).catch((error) => {
            console.log("データの取得に失敗しました(${error})");
        })
        return data;
    }
    
    //テーブルのドラックした時の処理---------------------------------------
    var isMouseDown = false;
    $(".drag")
        .mousedown(function () {
            isMouseDown = true;
            $(this).toggleClass("highlighted");
            return false; // prevent text selection
        })
        .mouseover(function () {
            if (isMouseDown) {
                $(this).toggleClass("highlighted");
            }
        });
    $(document)
        .mouseup(function () {
            isMouseDown = false;
        });
    //ログイン画面へ遷移--------------------------------------------
    function onClickLogin(){
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                userid = firebase.auth().currentUser.uid;
            }
            else{
                let projectId=getParam("project");
                window.location="login.html?project="+projectId;
            }
        });
    }
    //----------------------------------------------------------------
    //URLをコピーする---------------------------------------------------
    copyUrl.value = location.href;
    function copyToClipboard() {
        // コピー対象をJavaScript上で変数として定義する
        var copyTarget = $("#copyUrl")[0];
        // コピー対象のテキストを選択する
        copyTarget.select();
        // 選択しているテキストをクリップボードにコピーする
        document.execCommand("Copy");
        // コピーをお知らせする
        alert("コピーできました! : " + copyTarget.value);
    }
    //ログインしていない人が名前を入力したとき-------------------------------
    $("#unLoginUserName")[0].addEventListener("keypress", getUnLoginUserName);
    function getUnLoginUserName(e) {
        if (e.keyCode === 13) {
            unLoginUserName = $("#unLoginUserName").val();
            $("#modalOpen").hide();
            $("<p>" + unLoginUserName + "</p>").appendTo(plusCellbox);

        }
    }
    //表示非表示時の変更-----------------
    //modalを表示・非表示する
    var modal = document.getElementById('modal-content');
    //var bodyModal=document.getElementsByClassName('modalBody')[0];
    //var nameModal=document.getElementsByClassName('modalName')[0];

    function  modalOpen(){
        console.log("open");
        modal.style.display='block';
    };
    function modalClose(){
        console.log("close");
        modal.style.display='none';
    }
    /*function modalNameOpen(){
        bodyModal.style.display='none';
        nameModal.style.display='block';
    }
    function modalNameClose(){
        modal.style.display='none';
        nameModal.style.display="none";
        bodyModal.style.display="block";
    }
    function nameDecision(){
        let userName=document.getElementById('unknown-name').value;
        db.collection("project").doc(projectid).update({
            projectMemberName:firebase.firestore.FieldValue.arrayUnion(userName)
        })
    } */   
    //登録ボタンが押されたときの処理---------------------------------------
    function scheduleSave() {
        var scheduleArray = [];
        var i = 0;
        for (var j = getProjectPeriodStart(); j <= finish; j.setDate(j.getDate() + 1)) {
            for (var k = 0; k < 144; k++) {
                if ($("#cell" + i).hasClass("highlighted")) {
                    scheduleArray.push(1);
                } else {
                    scheduleArray.push(0);
                }
                i++;
            }
        }
        if (uid != null) {
            //ログインした人のための処理----------
            setLoginMember(getProjectMembers().length + 1, scheduleArray);
        } else {
            //ログインしてない人のための処理-------
            setJoinMember(getUserName(uid), scheduleArray);
        }
    }

</script>
<style>
    table td.drag {
        min-width: 20px;
        height: 10px;
        text-align: center;
        vertical-align: middle;
        background-color: #ccc;
        border: 1px solid #fff;
    }

    th {
        text-align: left;
        border: 0.5px solid black;
    }

    table td.notHighlight {
        min-width: 20px;
        height: 10px;
        text-align: center;
        vertical-align: middle;
        background-color: #ccc;
        border: 1px solid #fff;
    }


    table td.highlighted {
        /*background-color: #999;*/
        background-color: rgb(240, 173, 96);
    }

    table {
        display: block;
        overflow-x: scroll;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
    }

    #modal-content{
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        height: 100%;
        width: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
</style>

</html>
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
   
  <!--  -->
  <script src="/__/firebase/6.2.0/firebase-app.js"></script>
  <script src="/__/firebase/6.2.0/firebase-firestore.js"></script>
  <script src="/__/firebase/6.2.0/firebase-auth.js"></script>
  <script src="/__/firebase/init.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> 
    <title>ホームページ</title>
    <link rel="stylesheet" href="login.css" />
    <style>
      .header-title {
        padding: 10px;
        margin-bottom: 100px;
        font-size: 18px;
        border-bottom: 1px solid #aaa;
      }
      .hide {
        display: none;
      }
      #info {
        text-align: center;
        font-size: 4em;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1 class="header-title">ホームページ</h1>
    
    <div class="container">
      <div id="inputarea">
        <button id="mypage" onclick="mypageClick()">Myページ へ</button><br><br>
        <input id="project-name" type="text" placeholder="プロジェクト名">
        <p>プロジェクト開始: <input id="project-start" type="date"></p>
        <p>プロジェクト終了: <input id="project-finish" type="date"></p>
        <button id="project-make" onclick="forProject()"> プロジェクトを作成 </button>

      </div>
    </div>
    
    <script>
      let db=firebase.firestore();
      let userid="";
      //認証状態の確認
      function mypageClick(){   
        firebase.auth().onAuthStateChanged(function(user) {
          if(user) {
            userid = firebase.auth().currentUser.uid;
            loginDisplay();
          }
          else {
            window.location="login.html";
          }
          });
        }
        function loginDisplay() {
        //  logout.classList.remove('hide');
          inputarea.classList.add('hide');
          let userName=getUserName();
          info.textContent = "ログイン中です!";
          window.location="mypage.html";
        }
        function getUserName(){
          var userName=db.collection("account").doc(userid).get().data()["name"];
          return userName;
        }

        function forProject(){
          var projectName = document.getElementById("project-name").value;
          var projectStartPeriod=document.getElementById("project-start").value;
          var projectFinishPeriod=document.getElementById("project-finish").value;

          var projectId=getProjectId();
          let url="kumanomim2.web.app/project.html"+"?id="+projectId;
          console.log(projectName);
          console.log(url);
          createProject(projectName,projectStartPeriod,projectFinishPeriod,projectId,url);
          console.log("成功");
          //window.location=url;
        }

        function getProjectId(){
          let collection=db.collection("project");
          let newProjectId=collection.doc().id;
          return newProjectId;
        }

        /*プロジェクトを作成する関数.小塚*/
        /*
        *projectName            :String
        *projectStartPeriod     :Date
        *projectEndPeriod       :Date
        */
        function createProject( projectName, projectStartPeriod, projectEndPeriod,projectId,url){

          var start=projectStartPeriod.split("-",3);
          var finish=projectEndPeriod.split("-",3);
          /*日時をyyyymmdd(y:年,m:月,d:日)の形に変換*/
          var startTime = parseInt(start[0] * 10000) + parseInt(start[1] * 100) + parseInt(start[2]);
          var endTime = parseInt(finish[0] * 10000) + parseInt(finish[1] * 100) + parseInt(finish[2]);
          console.log(start[0],start[1],start[2]);
          //データベースにドキュメントを更新.決まっていいない値はnullか0
          db.collection("project").doc(projectId).set({
              URL: url,
              menberId:  [null],
              projectName: projectName,
              projectPeiriod: [startTime,endTime],
              projectDecisionName: 0,
              projectmenberName: [null]
          })
        }

    </script>
  </body>
</html>
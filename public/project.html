<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!--  -->
    <script src="/__/firebase/6.2.0/firebase-app.js"></script>
    <script src="/__/firebase/6.2.0/firebase-firestore.js"></script>
    <script src="/__/firebase/6.2.0/firebase-auth.js"></script>
    <script src="/__/firebase/init.js"></script>
    <title></title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>

<body>
    <!-- コピー対象要素とコピーボタン -->
    <input id="copyUrl" type="url" readonly>
    <button onclick="copyToClipboard()">URLをコピー</button>

    <div id="dragTableArea"></div>
    <div id="loginSelectArea" class="hideArea">
        <button id="login" onclick="onClickLogin()">ログイン</button>
        ログインしないで利用:
        <input id="unLoginUserName" type="text" placeholder="名前を入力してください." style="width: 12em;">
    </div>
    <button id="scheduleSaveButton" onclick="scheduleSave()">登録</button>
</body>

<script src="firebaseCode.js"></script>
<script src="firebaseCode_ryosuke.js"></script>
<script src="firebaseFunctions.js"></script>

<script>
    //----------------------------------------------------------------
    let db = firebase.firestore();
    //ログインしてない人の名前------------
    var unLoginUserName;
    var userId = null;
    //--------------------------------
    //テーブル作成------------------------------------------------------
    //状況の取得------------------------

    document.addEventListener('DOMContentLoaded', async (event) => {
        //開始日と終了日の取得----------------
        var finish = await getProjectPeriodFinish();
        var start = await getProjectPeriodStart();
        var tableTag = $("<table id=\"dragTable\" cellpadding=\"0\" cellspacing=\"0\">");
        //1行目の作成-----------------------
        var tableFirstRow = $("<tr></tr>").appendTo(tableTag);
        $("<th rowspan=\"2\"></th>").appendTo(tableFirstRow);
        for (let i = new Date(start); i <= finish; i.setDate(i.getDate() + 1)) {
            $("<th colspan=\"144\">" + i + "</th>").appendTo(tableFirstRow);
        }
        //2行目の作成-----------------------
        var tableSecondRow = $("<tr></tr>").appendTo(tableTag);
        for (let i = new Date(start); i <= finish; i.setDate(i.getDate() + 1)) {
            for (let j = 0; j < 24; j++) {
                $("<th colspan=\"6\" class=\"time\">" + j + ":" + "</th>").appendTo(tableSecondRow);
            }
        }
        //それぞれのメンバーの行--------------
        var memberName = await getProjectMembers();
        console.log(memberName);
        console.log(memberName.length);
        for (let i = 0; i < memberName.length; i++) {
            var memberRow = await getProjectMemberSchedule(i);
            var tableRow = $("<tr></tr>").appendTo(tableTag);
            $("<th>" + memberName[i] + "</th>").appendTo(tableRow);
            var count = 0;
            for (let j = new Date(start); j <= finish; j.setDate(j.getDate() + 1)) {
                for (let k = 0; k < 144; k++) {
                    if (memberRow[count] == 0) {
                        $("<td class=\"notHighlight\"></td>").appendTo(tableRow);
                    } else if (memberRow[count] == 1) {
                        $("<td class=\"highlighted\"></td>").appendTo(tableRow);
                    }
                    count++;
                }
            }
        }
        //新規欄-----------------------------------------------------------
        var tableRow = $("<tr></tr>").appendTo(tableTag);
        var plusCellbox = $("<th></th>").appendTo(tableRow);
        //認証状態の確認
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                userId = firebase.auth().currentUser.uid;
                console.log(userId);

            }
            hantei();
        });
        function sleep(waitMsec) {
            var startMsec = new Date();

            // 指定ミリ秒間だけループさせる（CPUは常にビジー状態）
            while (new Date() - startMsec < waitMsec);
        }

        //sleep(10000);
        console.log("ここ");
        async function hantei() {
            if (userId != null) {
                console.log("ろぐいんした");
                //ログインした人のための処理----------
                $("<p>" + (await getUserName(userId)) + "<p>").appendTo(plusCellbox);
                var userSchedule = await getUserSchedule(userId);
                var i = 0;
                for (let j = new Date(start); j <= finish; j.setDate(j.getDate() + 1)) {
                    for (let k = 0; k < 144; k++) {
                        if (userSchedule[i] == 0) {
                            $("<td id=\"cell" + i + "\" class=\"drag\"></td>").appendTo(tableRow);
                        } else {
                            $("<td id=\"cell" + i + "\" class=\"highlighted drag\"></td>").appendTo(tableRow);
                        }
                        i++;
                    }
                }
            }
            else {
                console.log("ろぐいんしてない");
                //ログインしてない人のための処理-------
                var i = 0;
                $("<div id=\"modalOpen\" class=\"openbtn\"><span></span><span></span></div>").appendTo(plusCellbox);
                for (let j = new Date(start); j <= finish; j.setDate(j.getDate() + 1)) {
                    for (let k = 0; k < 144; k++) {
                        $("<td id=\"cell" + i + "\" class=\"drag\"></td>").appendTo(tableRow);
                        i++;
                    }
                }
            }

            console.log("無視");
            $("#dragTableArea").append(tableTag);
            //テーブルのドラックした時の処理---------------------------------------
            var isMouseDown = false;
            $(".drag")
                .mousedown(function () {
                    isMouseDown = true;
                    $(this).toggleClass("highlighted");
                    return false; // prevent text selection
                })
                .mouseover(function () {
                    if (isMouseDown) {
                        $(this).toggleClass("highlighted");
                    }
                });
            $(document)
                .mouseup(function () {
                    isMouseDown = false;
                });

            //+ボタンを押された時のログイン関係処理---------------------------------
            $(".openbtn").click(function () {
                if (!$(this).hasClass("active")) {
                    $(".hideArea").show();
                }
                else {
                    $(".hideArea").hide();
                }
                $(this).toggleClass("active");
            })
        }
        console.log("作成完了");
    });

    async function getProjectPeriod() {
        var start = await getProjectPeriodStart();
        var finish = await getProjectPeriodFinish();
        for (var i = new Date(start); i <= finish; i.setDate(i.getDate() + 1)) {
        }
        return i;
    }

    //仮のfunction----------------------------------------------------
    function getParam(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
    /*あるプロジェクトの期間のあるユーザーのマイスケジュールを返す*/
    //async function getUserSchedule(userId){
    /*あるプロジェクトIDのプロジェクトの開始日、終了日を取得する*/
    /*    var projectId = getParam("project");
        var period = [];
        period = db.collection("project").doc(projectId).get()
        .then((querySnapshot)=>{
            return querySnapshot.data()[""]
        })
        /*あるユーザーIDをもつユーザーのプロジェクトの期間のマイスケジュールを取得する*/
    /*    var projectPeriodMySchedule = [];
        projectPeriodMySchedule = db.collection("account").doc(userId).collection("myScheduleId").where("date", ">=", period[0])
                                                                                            .where("date", "<=", period[1]).get();
        return projectPeriodMySchedule;
    }*/
    async function getUserName(userId) {
        if (!userId) {
            userId = firebase.auth().currentUser.uid;
        }
        console.log(userId);
        var userName = await db.collection("account").doc(userId).get()
            .then((querySnapshot) => {
                //console.log(querySnapshot);
                let temp = querySnapshot.data()["name"];
                //console.log(temp);
                console.log(temp);
                return temp;
            })
        console.log(userName);
        return userName;
    }
    /*
    function getProjectMembers(){
        let ID;
        let buff;
        ID = getParam("project");
        const docRef = db.ref("project/ID");
        let members;
        docRef.get().then((doc)=>{
            members = doc.data();
            console.log(members);
        }).catch((error)=>{
            console.log("データ取得失敗");
        })
        return members;
    }
    */
    /*
        async function getProjectMembers() {
            let ID;
            let buff;
    
            ID = getParam("project");
            buff = await db.collection("project").doc(ID).get()
                .then((querySnapshot) => {
                    //console.log(querySnapshot.data()["projectmenberName"]);
                    let temp = querySnapshot.data()["projectmenberName"];
                    console.log(temp);
                    //buff = querySnapshot.data()["projectmenberName"];
                    //console.log(buff);
                    //return buff; //MemberのMがfirebaseで小文字になってる
                    //console.log(start);
                    //const docSnapshot = querysnapshot.docs;
                    //console.log(docSnapshot);
                    return temp;
                })
                .catch((error) => {
                    console.log("データの取得失敗");
                })
            console.log(buff);
            return buff; //MemberのMがfirebaseで小文字になってる
        }
    
        async function getProjectPeriodStart() {
            let ID;
            ID = getParam("project");
            var buff;
            buff = db.collection("project").doc(ID);
            var start = buff.get().then((querySnapshot) => {
                //console.log(querySnapshot.data()["projectPeiriod"]); 
                let start = new Date(querySnapshot.data()["projectPeiriod"][0] / 10000, (querySnapshot.data()["projectPeiriod"][0] % 10000) / 100, (querySnapshot.data()["projectPeiriod"][0] % 100));
                //console.log(start);
                return start;
            })
                .catch((error) => {
                    console.log("データの取得失敗");
                })
            //console.log("取得S"+start);
            return start;
        }
    
        async function getProjectPeriodFinish() {
            let ID;
            ID = getParam("project");
            var buff;
            buff = db.collection("project").doc(ID);
            var finish = await buff.get().then((querySnapshot) => {
                //console.log(querySnapshot.data()["projectPeiriod"]); 
                let end = new Date(querySnapshot.data()["projectPeiriod"][1] / 10000, (querySnapshot.data()["projectPeiriod"][1] % 10000) / 100, (querySnapshot.data()["projectPeiriod"][1] % 100));
                //console.log(end);
                return end;
            })
                .catch((error) => {
                    console.log("データの取得失敗");
                })
            //console.log("取得F"+finish);
            return finish;
        }
    
        async function getProjectMemberSchedule(memberIndex) {
            /*
            var ID=getParam("project");
            var data = [];
            data=await db.collection("project").doc(ID).collection("projectMenberPeriod").where("memberIndex","==",memberIndex)
            .get().then((querySnapshot) =>{
                let snap= querySnapshot.forEach((doc) => {
                    let temp = doc.data()["projectSchedule"];
                    //projectSchedule.push(data.projectSchedule);
                    console.log(temp);
                    return temp;
                });
                console.log(snap);
                return snap;
            }).catch((error) => {
                console.log("データの取得に失敗しました(${error})");
            })
            console.log(data);
            return data;
            */
    /*        return [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1
            ];
        }
    */

    //ログイン画面へ遷移--------------------------------------------
    function onClickLogin() {
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                userId = firebase.auth().currentUser.uid;
                console.log(userId);
            }
            else {
                let projectId = getParam("project");
                window.location = "login.html?project=" + projectId;
            }
        });
    }
    //----------------------------------------------------------------

    //URLをコピーする---------------------------------------------------
    copyUrl.value = location.href;
    function copyToClipboard() {
        // コピー対象をJavaScript上で変数として定義する
        var copyTarget = $("#copyUrl")[0];
        // コピー対象のテキストを選択する
        copyTarget.select();
        // 選択しているテキストをクリップボードにコピーする
        document.execCommand("Copy");
        // コピーをお知らせする
        alert("コピーできました! : " + copyTarget.value);
    }
    //ログインしていない人が名前を入力したとき-------------------------------
    $("#unLoginUserName")[0].addEventListener("keypress", getUnLoginUserName);
    function getUnLoginUserName(e) {
        if (e.keyCode === 13) {
            unLoginUserName = $("#unLoginUserName").val();
            $("#modalOpen").hide();
            $("<p>" + unLoginUserName + "</p>").appendTo(plusCellbox);
        }
    }

    //登録ボタンが押されたときの処理---------------------------------------
    function scheduleSave() {
        var scheduleArray = [];
        var i = 0;
        for (var j = getProjectPeriodStart(); j <= finish; j.setDate(j.getDate() + 1)) {
            for (var k = 0; k < 144; k++) {
                if ($("#cell" + i).hasClass("highlighted")) {
                    scheduleArray.push(1);
                } else {
                    scheduleArray.push(0);
                }
                i++;
            }
        }
        if (userId != null) {
            //ログインした人のための処理----------
            setLoginMember(getProjectMembers().length + 1, scheduleArray);
        } else {
            //ログインしてない人のための処理-------
            setJoinMember(getUserName(userId), scheduleArray);
        }
    }
/*
                                                                    function getProjectMembers(){
                                                                        let ID;
                                                                        let buff;
                                                                        ID = getParam("project");
                                                                        const docRef = db.ref("project/ID");
                                                                        let members;
                                                                        docRef.get().then((doc)=>{
                                                                            members = doc.data();
                                                                            console.log(members);
                                                                        }).catch((error)=>{
                                                                            console.log("データ取得失敗");
                                                                        })
                                                                        return members;
                                                                    }
                                                                    */
    /*
    async function getProjectMembers() {
        let ID;
        let buff;

        ID = getParam("project");
        buff = await db.collection("project").doc(ID).get()
            .then((querySnapshot) => {
                //console.log(querySnapshot.data()["projectmenberName"]);
                let temp = querySnapshot.data()["projectmenberName"];
                console.log(temp);
                //buff = querySnapshot.data()["projectmenberName"];
                //console.log(buff);
                //return buff; //MemberのMがfirebaseで小文字になってる
                //console.log(start);
                //const docSnapshot = querysnapshot.docs;
                //console.log(docSnapshot);
                return temp;
            })
            .catch((error) => {
                console.log("データの取得失敗");
            })
        console.log(buff);
        return buff; //MemberのMがfirebaseで小文字になってる
    }

    async function getProjectPeriodStart() {
        let ID;
        ID = getParam("project");
        var buff;
        buff = db.collection("project").doc(ID);
        var start = buff.get().then((querySnapshot) => {
            //console.log(querySnapshot.data()["projectPeiriod"]); 
            let start = new Date(querySnapshot.data()["projectPeiriod"][0] / 10000, (querySnapshot.data()["projectPeiriod"][0] % 10000) / 100, (querySnapshot.data()["projectPeiriod"][0] % 100));
            //console.log(start);
            return start;
        })
            .catch((error) => {
                console.log("データの取得失敗");
            })
        //console.log("取得S"+start);
        return start;
    }

    async function getProjectPeriodFinish() {
        let ID;
        ID = getParam("project");
        var buff;
        buff = db.collection("project").doc(ID);
        var finish = await buff.get().then((querySnapshot) => {
            //console.log(querySnapshot.data()["projectPeiriod"]); 
            let end = new Date(querySnapshot.data()["projectPeiriod"][1] / 10000, (querySnapshot.data()["projectPeiriod"][1] % 10000) / 100, (querySnapshot.data()["projectPeiriod"][1] % 100));
            //console.log(end);
            return end;
        })
            .catch((error) => {
                console.log("データの取得失敗");
            })
        //console.log("取得F"+finish);
        return finish;
    }

    async function getProjectMemberSchedule(memberIndex) {
        
        var ID=getParam("project");
        var data = [];
        data=await db.collection("project").doc(ID).collection("projectMenberPeriod").where("memberIndex","==",memberIndex)
        .get().then((querySnapshot) =>{
            let snap= querySnapshot.forEach((doc) => {
                let temp = doc.data()["projectSchedule"];
                //projectSchedule.push(data.projectSchedule);
                console.log(temp);
                return temp;
            });
            console.log(snap);
            return snap;
        }).catch((error) => {
            console.log("データの取得に失敗しました(${error})");
        })
        console.log(data);
        return data;
        
        return [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1
        ];
    }*/
</script>
<style>
    .hideArea {
        display: none;
    }

    .doubleHeading,
    .heading {
        position: sticky;
        top: 0;
        left: 0;
        background-color: #fff;
    }

    .doubleHeading ::before,
    .heading ::before {
        content: "";
        position: absolute;
        top: -1px;
        left: -1px;
        width: 100%;
        height: 100%;
        border: 1px solid #ccc;
    }

    .doubleHeading {
        z-index: 2;
    }

    .heading {
        z-index: 1;
    }

    .openbtn {
        position: relative;
        width: 50px;
        height: 50px;
    }

    .openbtn span {
        display: inline-block;
        transition: all.4s;
        position: absolute;
        left: 13px;
        height: 2px;
        background-color: #666;

    }

    .openbtn span:nth-of-type(1) {
        top: 25px;
        width: 50%;
        transform: rotate(90deg);
    }

    .openbtn span:nth-of-type(2) {
        top: 25px;
        width: 50%;
    }

    .openbtn.active span:nth-of-type(1) {

        transform: rotate(-45deg);
        width: 50%;
    }

    .openbtn.active span:nth-of-type(2) {

        transform: rotate(45deg);
        width: 50%;
    }

    table td.drag {
        min-width: 20px;
        height: 10px;
        text-align: center;
        vertical-align: middle;
        background-color: #ccc;
        border: 1px solid #fff;
    }

    th {
        text-align: left;
        border: 0.5px solid black;
        background-color: #ccc;
        padding: 0 1em;
    }

    td {
        min-width: 20px;
        height: 10px;
        text-align: center;
        vertical-align: middle;
        border: 1px solid #fff;
    }

    table td.notHighlight {
        background-color: #ccc;
    }

    table td.highlighted {
        min-width: 20px;
        /*background-color: #999;*/
        background-color: rgb(240, 173, 96);
    }

    table {
        display: block;
        overflow-x: scroll;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
    }
</style>

</html>